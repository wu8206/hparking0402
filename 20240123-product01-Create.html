<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表單練習(商品建檔)</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/myall.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                控制台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <div class="ms-auto">
                    <span class="text-warning h3" id="user_message"></span>
                    <button class="btn btn-danger d-none" id="s02_logout_btn">登出</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="row justify-content-center py-5">
            <div class="col-md-10 p-3 rounded-3 shadow-lg border border-2 border-dark">
                <div class="mb-3 form-floating">
                    <input type="text" class="form-control" placeholder="" id="pname" name="pname" list="pname_option"> 
                    <label for="pname">商品名稱</label>
                    <datalist id="pname_option">
                        <option value="珍珠奶茶">珍珠奶茶</option>
                        <option value="紅茶">紅茶</option>
                        <option value="綠茶">綠茶</option>
                        <option value="白開水">白開水</option>
                    </datalist>
                    <div class="valid-feedback">字數符合規定</div>
                    <div class="invalid-feedback">字數不符合規定</div>
                </div>
                <div class="mb-3">
                    <label for="price" class="form-label">價格(NT)</label>
                    <input type="number" min="0" max="100" value="50" class="form-control" id="price" name="price">
                    <div class="valid-feedback">價格在範圍內</div>
                    <div class="invalid-feedback">價格超出範圍(1-100)</div>
                </div>
                <div class="mb-3">
                    <select name="sugar" id="sugar" class="form-select is-invalid">
                        <option selected disabled>---選擇甜度---</option>
                        <option value="全糖">全糖</option>
                        <option value="半糖">半糖</option>
                        <option value="少糖">少糖</option>
                        <option value="無糖">無糖</option>
                    </select>
                    <div class="valid-feedback">已選擇甜度</div>
                    <div class="invalid-feedback">未選擇甜度</div>
                </div>
                <div class="mb-3">
                    <select name="ice" id="ice" class="form-select">
                        <option selected disabled>---選擇冰塊---</option>
                        <option value="正常冰">正常冰</option>
                        <option value="少冰">少冰</option>
                        <option value="微冰">微冰</option>
                        <option value="去冰">去冰</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="num01" class="form-label">數量(杯): <span class="h5 text-danger" id="num01_text">50</span></label>
                    <input type="range" class="form-range" value="50" min="1" max="100" step="1" id="num01" name="num01">
                </div>
                <div class="form-check form-switch">
                    <input type="checkbox" name="switch01" id="switch01" class="form-check-input">
                    <label for="switch01" class="form-check-label">外送</label>
                </div>
                <div class="my-3">
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="chk01" name="chk" value="珍珠">
                        <label for="chk01" class="form-check-label">珍珠</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="chk02" name="chk" value="粉圓">
                        <label for="chk02" class="form-check-label">粉圓</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="chk03" name="chk" value="布丁">
                        <label for="chk03" class="form-check-label">布丁</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="checkbox" class="form-check-input" id="chk04" name="chk" value="蒟蒻">
                        <label for="chk04" class="form-check-label">蒟蒻</label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="radio01" name="rad" value="刷卡" checked>
                        <label for="radio01" class="form-check-label">刷卡</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="radio02" name="rad" value="Line Pay">
                        <label for="radio02" class="form-check-label">Line Pay</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" id="radio03" name="rad" value="付現">
                        <label for="radio03" class="form-check-label">付現</label>
                    </div>
                </div>
                <div class="text-end">
                    <button class="btn btn-info" id="ok_btn">確認</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div id="showmsg"></div>
    </div>
    
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script>
        var switch01 = "不需要外送"; //紀錄外送狀態
        var num01 =50; //紀錄杯數
        var flag_pname = false;
        var flag_price = true; //已經有價格初始值
        var flag_sugar = false;
        $(function(){
            //判斷是否登入
            if (getCookie("UID01") != "") {
                //UID01存在, 傳遞至後端api 判斷是否合法
                var dataJSON = {};
                dataJSON["UID01"] = getCookie("UID01");
                console.log(JSON.stringify(dataJSON));
                $.ajax({
                    type: "POST",
                    url: "member-Check_UID-api.php",
                    data: JSON.stringify(dataJSON),
                    dataType: "json",
                    success: showdata_Check_UID,
                    error: function () {
                        alert("error-member-Check_UID-api.php");
                    }
                });
            }else{
                location.href = "SPA.html";
            }

            //登出按鈕監聽 #s02_logout_btn
            $("#s02_logout_btn").click(function () {
                setCookie("UID01", "", 7);
                location.href = "SPA.html";
            });
            
            //監聽_即時監聽 #price
            $("#price").bind("input propertychange", function(){
                console.log($(this).val().length);
                if($(this).val()>0 && $(this).val()<101){
                    //價格在範圍內
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_price = true;
                }else{
                    //價格超出範圍(1-100)
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");  
                    flag_price = false;                  
                }
            });

            //監聽_即時監聽 #sugar
            $("#sugar").bind("input propertychange", function(){            
                if($(this).val()!=""){
                    //已選擇甜度
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");  
                    flag_sugar = true;            
                }
            });            
            
            //監聽_即時監聽 #pname
            //.val().length是字數，.val()是字
            $("#pname").bind("input propertychange", function(){
                console.log($(this).val().length);
                if($(this).val().length>0 && $(this).val().length<7){
                    //字數符合規定
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_pname = true;
                }else{
                    //字數不符合規定
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");  
                    flag_pname = false;                  
                }
            });
            
            //監聽switch外送
            $("#switch01").change(function(){
                console.log($(this).is(':checked'));
                if($(this).is(':checked')){
                    $(this).next().text('需要外送!');
                    switch01 = '需要外送';
                }else{
                    $(this).next().text('不需要外送!');
                    switch01 = '不需要外送';
                }
            });

            //監聽_即時監聽 range #num01
            $("#num01").bind("input propertychange", function () {
                console.log($(this).val());
                $("#num01_text").text($(this).val());
                num01 = $(this).val()
            });
            // $("#num01").change(function () {
            //     console.log($(this).val());
            // });  

            //按鈕監聽
            $("#ok_btn").click(function(){
                if(flag_pname && flag_price && flag_sugar){
                    console.log($("#pname").val());
                    console.log($("#price").val());


                //收集checkbox加料區的資料
                var chkArray = [];
                $.each($("input[name='chk']:checked"), function(){
                    console.log($(this).val());
                    chkArray.push($(this).val());
                });
                if(chkArray.length == 0){
                    chkArray.push("不加料");
                }
                console.log(chkArray);

                //收集radio付款方式的資料
                var rad_pay; //紀錄付款方式
                $.each($("input[name='rad']:checked"), function(){
                    rad_pay = $(this).val();
                })

                $("#showmsg").html("<h1>商品名稱: "+ $("#pname").val() +"</h1><h3>價格(NT): "+$("#price").val()+ "</h3><h3>甜度: " + $("#sugar").val()+"</h3><h3>冰塊: " + $("#ice").val()+"</h3><h1>杯數: " + num01 +"</h1><h3>外送需求: " + switch01 +"</h3><h1>加料: "+ chkArray.join("， ") + "</h1><h1>總價: " + $("#price").val()*num01 + "元</h1><h1>付款方式: " + rad_pay + "</h1>");

                //將傳遞至後端api參數 轉換成json格式
                //{"Pname":"奶茶", "Price":"50", "Sugar":"全糖", "Num":"10", "Delivery":"true", "Added":"珍珠", "Pay":"刷卡", "Total":"500"}
                var dataJSON = {};
                dataJSON["Pname"] = $("#pname").val();
                dataJSON["Price"] = $("#price").val();
                dataJSON["Sugar"] = $("#sugar").val();
                dataJSON["Num"] = num01;
                dataJSON["Delivery"] = switch01;
                dataJSON["Added"] = chkArray.join(", ");
                dataJSON["Pay"] = rad_pay;
                dataJSON["Total"] = $("#price").val()*num01;

                console.log(JSON.stringify(dataJSON));
                
                //傳遞至後端
                $.ajax({
                    type: "POST",
                    url: "http://192.168.10.76/202312/20240123-product01-Create-api.php",
                    data: JSON.stringify(dataJSON),
                    contentType: "application/json;charset=utf-8",
                    dataType: "json",
                    success: showdata,
                    error: function(){
                        alert("error-http://192.168.10.76/202312/20240123-product01-Create-api.php");
                    }
                });
                }else{
                    alert("欄位有誤, 請修正!");
                }
            });
        });
        
        function showdata(data){
            console.log(data);
        }

        function showdata_Check_UID(data) {
            console.log(data);
            if (data.state) {
                //驗證成功
                $("#user_message").text(data.data[0].Username + "登入中!");

                //顯示登出按鈕
                $("#s02_logout_btn").removeClass("d-none");
            }else{
                location.href = "SPA.html";
            }
        }

        //w3s
        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }
        //w3s
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    </script>
</body>
</html>